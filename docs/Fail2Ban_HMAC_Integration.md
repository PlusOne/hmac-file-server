
# Fail2Ban Integration with HMAC Server

This guide explains how to integrate Fail2Ban with the HMAC Server for enhanced security by banning IPs after multiple failed attempts or malicious activity.

---

## Overview

Fail2Ban monitors logs for patterns indicating suspicious behavior, such as multiple failed login attempts or unusual request patterns. When such behavior is detected, Fail2Ban can take actions like banning the offending IP by modifying firewall rules.

---

## Prerequisites

- A running instance of the HMAC Server.
- Fail2Ban installed on the server.
- Root or sudo access for configuration.

---

## Configuring Fail2Ban for HMAC Server

### Step 1: Create a Jail for the HMAC Server

Edit the Fail2Ban jail configuration file (e.g., `/etc/fail2ban/jail.local`):

```ini
[hmac-auth]
enabled = true
port = 8080
logpath = /var/log/hmac-file-server.log
maxretry = 3
bantime = 3600
findtime = 600
action = iptables[name=hmac-auth, port=8080, protocol=tcp]
```

- **`enabled`**: Enable this jail.
- **`port`**: Port number the HMAC server listens on.
- **`logpath`**: Path to the HMAC server log file.
- **`maxretry`**: Number of allowed retries before banning.
- **`bantime`**: Duration of the ban (in seconds).
- **`findtime`**: Time window (in seconds) for detecting retries.
- **`action`**: The action Fail2Ban should take (e.g., modify firewall rules).

---

### Step 2: Create a Filter for HMAC Server Logs

Create a new filter file for HMAC Server (e.g., `/etc/fail2ban/filter.d/hmac-auth.conf`):

```ini
[Definition]
failregex = ^.*Failed HMAC authentication from <HOST>.*$
ignoreregex =
```

- **`failregex`**: Regular expression to match failed authentication attempts in the log file.
- **`ignoreregex`**: Patterns to ignore (leave empty if none).

Ensure the regex matches the actual log entries generated by the HMAC Server.

---

### Step 3: Test the Configuration

Run the following command to test the Fail2Ban configuration:

```bash
sudo fail2ban-regex /var/log/hmac-file-server.log /etc/fail2ban/filter.d/hmac-auth.conf
```

Verify that the regex correctly identifies failed authentication attempts.

---

### Step 4: Restart Fail2Ban

Restart the Fail2Ban service to apply the changes:

```bash
sudo systemctl restart fail2ban
```

---

## Advanced Configuration

### Custom Ban Commands

If you need custom actions for banning or unbanning IPs, add the following to the jail configuration:

```ini
action = %(action_)s
         %(banaction)s[name=hmac-auth, port=8080, protocol=tcp]
         /usr/bin/fail2ban-client set hmac-auth ban <HOST>
```

Replace `<HOST>` with the offending IP address.

### Monitoring

Check the status of Fail2Ban and the HMAC server jail:

```bash
sudo fail2ban-client status
sudo fail2ban-client status hmac-auth
```

---

## Log Format

Ensure the HMAC server log format is compatible with Fail2Ban by including the source IP in each log entry. For example:

```
2024-11-19 12:34:56 [ERROR] Failed HMAC authentication from 192.168.1.100
```

Modify the HMAC server configuration if needed to include this format.

---

## Troubleshooting

- If bans are not working, check the Fail2Ban logs for errors:

```bash
sudo journalctl -u fail2ban
```

- Verify that the logpath and failregex match the HMAC server's log file and entries.

---

## Conclusion

Integrating Fail2Ban with the HMAC server enhances security by dynamically blocking malicious IPs. Adjust the configuration as needed to suit your environment.
